@model IEnumerable<峰哥造价课堂WEB.Models.MemberViewModel>
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@removeTagHelper Microsoft.AspNetCore.Mvc.TagHelpers.OptionTagHelper, Microsoft.AspNetCore.Mvc.TagHelpers

@{
    ViewData["Title"] = "会员权限管理";
    var statusFilter = ViewBag.StatusFilter as string ?? "all";
    var nickname = ViewBag.Nickname as string ?? "";
}

<div class="container mt-4">
    <h2>会员权限管理</h2>

<!-- 筛选区域 -->
<div class="card mb-4">
    <div class="card-body">
        <form asp-action="Members" method="get" class="row g-3">
            <div class="col-md-4">
                <select name="statusFilter" class="form-select" onchange="this.form.submit()">
                    <option value="all" @(statusFilter == "all" ? "selected" : "")>所有状态</option>
                    <option value="新用户" @(statusFilter == "新用户" ? "selected" : "")>新用户</option>
                    <option value="使用中" @(statusFilter == "使用中" ? "selected" : "")>使用中</option>
                    <option value="成本测算已到期" @(statusFilter == "成本测算已到期" ? "selected" : "")>成本测算已到期</option>
                    <option value="成本助手已到期" @(statusFilter == "成本助手已到期" ? "selected" : "")>成本助手已到期</option>
                </select>
            </div>
            <div class="col-md-6">
                <input type="text" name="nickname" class="form-control"
                       placeholder="输入微信昵称搜索" value="@ViewBag.Nickname">
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">搜索</button>
            </div>
        </form>
    </div>
</div>

    <!-- 会员表格 - 固定表头+懒加载 -->
    <div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
        <table class="table table-striped table-hover">
            <thead class="table-light sticky-top">
                <tr>
                    <th>ID</th>
                    <th>微信昵称</th>
                    <th>注册时间</th>
                    <th>试用状态</th>
                    <th>成本测算到期</th>
                    <th>成本助手到期</th>
                    <th>综合状态</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="membersTableBody">
                <!-- 初始加载的内容 -->
                @foreach (var item in Model.Take(20))
                {
                    <tr>
                        <td>@item.Id</td>
                        <td>@item.Nickname</td>
                        <td>@item.CreateTime.ToString("yyyy-MM-dd")</td>
                        <td>@item.Status</td>
                        <td>@(item.CesuanExpiry.HasValue ? item.CesuanExpiry.Value.ToString("yyyy-MM-dd") : "未开通")</td>
                        <td>@(item.ZhushouExpiry.HasValue ? item.ZhushouExpiry.Value.ToString("yyyy-MM-dd") : "未开通")</td>
                        <td>
                            <span class="badge @ViewBag.StatusStyles[item.ShowStatus]">@item.ShowStatus</span>
                        </td>
                        <td>
                            <a asp-action="AssignPermissions" asp-route-id="@item.Id" class="btn btn-sm btn-outline-primary">
                                分配权限
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- 加载中提示 -->
    <div id="loadingIndicator" class="text-center py-3 d-none">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">加载中...</span>
        </div>
    </div>

    <!-- 没有更多数据提示 -->
    <div id="noMoreData" class="text-center py-3 text-muted d-none">
        已经加载全部数据
    </div>
</div>

@section Scripts {
    <script>
        // 状态样式映射
        function getStatusClass(status) {
            switch(status) {
                case "使用中": return "bg-success";
                case "新用户": return "bg-info";
                case "成本测算已到期": return "bg-warning";
                case "成本助手已到期": return "bg-danger";
                default: return "bg-secondary";
            }
        }

        // 懒加载实现
        document.addEventListener('DOMContentLoaded', function() {
            const tableBody = document.getElementById('membersTableBody');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const noMoreData = document.getElementById('noMoreData');

            let page = 1; // 当前页码
            const pageSize = 20; // 每页条数
            let isLoading = false;
            let hasMoreData = true;

            // 滚动监听
            const tableContainer = document.querySelector('.table-responsive');
            tableContainer.addEventListener('scroll', handleScroll);

            // 处理滚动事件
            function handleScroll() {
                // 当滚动到容器底部附近时加载更多
                if (tableContainer.scrollTop + tableContainer.clientHeight >= tableContainer.scrollHeight - 100 &&
                    !isLoading && hasMoreData) {
                    loadMoreData();
                }
            }

            // 加载更多数据
            async function loadMoreData() {
                isLoading = true;
                loadingIndicator.classList.remove('d-none');

                try {
                    // 获取当前筛选条件
                    const statusFilter = new URLSearchParams(window.location.search).get('statusFilter') || 'all';
                    const nickname = new URLSearchParams(window.location.search).get('nickname') || '';

                    // 发起请求加载更多数据
                    const response = await fetch(`/Admin/MembersLoadMore?page=${page + 1}&pageSize=${pageSize}&statusFilter=${statusFilter}&nickname=${nickname}`);

                    if (!response.ok) throw new Error('加载失败');

                    const data = await response.json();

                    if (data.length === 0) {
                        hasMoreData = false;
                        noMoreData.classList.remove('d-none');
                        return;
                    }

                    // 添加新数据到表格
                    data.forEach(member => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${member.id}</td>
                            <td>${member.nickname}</td>
                            <td>${formatDate(member.createTime)}</td>
                            <td>${member.status}</td>
                            <td>${member.cesuanExpiry ? formatDate(member.cesuanExpiry) : '未开通'}</td>
                            <td>${member.zhushouExpiry ? formatDate(member.zhushouExpiry) : '未开通'}</td>
                            <td>
                                <span class="badge ${getStatusClass(member.showStatus)}">${member.showStatus}</span>
                            </td>
                            <td>
                                <a href="/Admin/AssignPermissions/${member.id}" class="btn btn-sm btn-outline-primary">
                                    分配权限
                                </a>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });

                    page++;
                } catch (error) {
                    console.error('加载更多数据失败:', error);
                } finally {
                    isLoading = false;
                    loadingIndicator.classList.add('d-none');
                }
            }

            // 日期格式化工具
            function formatDate(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                return date.toLocaleDateString('zh-CN');
            }
        });
    </script>
}